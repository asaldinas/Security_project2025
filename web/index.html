<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CampusHub</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
    header { display:flex; justify-content:space-between; align-items:center; }
    .note { border:1px solid #ddd; border-radius:12px; padding:12px; margin:8px 0; }
    .row { display:flex; gap:8px; margin:8px 0; }
    input, textarea { width:100%; padding:8px; border-radius:8px; border:1px solid #ccc; }
    button { padding:8px 12px; border-radius:8px; border:1px solid #ccc; background:#f7f7f7; cursor:pointer; }
    button:hover { background:#eee; }
    .muted { color:#666; font-size:0.9em; }
    .danger { color:#b00020; }
  </style>
</head>
<body>
  <header>
    <h1>CampusHub</h1>
    <nav id="nav"></nav>
  </header>

  <section id="auth"></section>
  <section id="notes" style="display:none;">
    <h2>Your Notes</h2>
    <div class="row">
      <input id="title" placeholder="Title" maxlength="120"/>
    </div>
    <div class="row">
      <textarea id="body" placeholder="Write a noteâ€¦" rows="4" maxlength="5000"></textarea>
    </div>
    <div class="row">
      <button id="create">Add Note</button>
    </div>
    <div id="list"></div>
  </section>

  <script>
    let csrfToken = null;
    async function fetchJSON(url, opts = {}) {
      const res = await fetch(url, { credentials: 'same-origin', ...opts });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }
    async function init() {
      try {
        const me = await fetchJSON('/me');
        document.getElementById('nav').innerHTML =
          `<span class="muted">Signed in as ${me.email}</span> <a href="/logout"><button>Logout</button></a>`;
        document.getElementById('auth').style.display = 'none';
        document.getElementById('notes').style.display = 'block';
        await refreshCsrf();
        await loadNotes();
      } catch {
        document.getElementById('auth').innerHTML =
          `<p>Sign in with your university Google account to manage notes securely.</p>
           <a href="/login"><button>Login with Google</button></a>`;
      }
    }
    async function refreshCsrf() {
      const data = await fetchJSON('/csrf', { headers: { 'Cache-Control': 'no-store' }});
      csrfToken = data.token;
    }
    async function loadNotes() {
      const notes = await fetchJSON('/api/notes');
      const list = document.getElementById('list');
      list.innerHTML = '';
      notes.forEach(n => {
        const el = document.createElement('div');
        el.className = 'note';
        el.innerHTML = `
          <strong>${n.title}</strong>
          <div class="muted">${new Date(n.updated_at).toLocaleString()}</div>
          <p>${n.body.replace(/</g,'&lt;')}</p>
          <div class="row">
            <button data-id="${n.id}" class="edit">Edit</button>
            <button data-id="${n.id}" class="delete danger">Delete</button>
          </div>`;
        list.appendChild(el);
      });
    }
    document.addEventListener('click', async (e) => {
      if (e.target.id === 'create') {
        const title = document.getElementById('title').value.trim();
        const body = document.getElementById('body').value.trim();
        await fetch('/api/notes', {
          method:'POST',
          credentials:'same-origin',
          headers:{ 'Content-Type':'application/json', 'x-csrf-token': csrfToken },
          body: JSON.stringify({ title, body })
        });
        document.getElementById('title').value='';
        document.getElementById('body').value='';
        await refreshCsrf();
        await loadNotes();
      }
      if (e.target.classList.contains('delete')) {
        const id = e.target.dataset.id;
        await fetch(`/api/notes/${id}`, { method:'DELETE', credentials:'same-origin', headers:{ 'x-csrf-token': csrfToken } });
        await refreshCsrf();
        await loadNotes();
      }
      if (e.target.classList.contains('edit')) {
        const id = e.target.dataset.id;
        const title = prompt('New title:');
        if (title === null) return;
        const body = prompt('New body:');
        if (body === null) return;
        await fetch(`/api/notes/${id}`, {
          method:'PUT',
          credentials:'same-origin',
          headers:{ 'Content-Type':'application/json', 'x-csrf-token': csrfToken },
          body: JSON.stringify({ title, body })
        });
        await refreshCsrf();
        await loadNotes();
      }
    });
    init();
  </script>
</body>
</html>
